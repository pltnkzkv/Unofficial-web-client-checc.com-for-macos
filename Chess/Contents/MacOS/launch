#!/bin/bash

###############################################################################
# Chess.app launcher (FINAL FINAL)
# Uses system universal Python forced to arm64
###############################################################################

set -e

# --- –õ–æ–≥ ---
LOG_FILE="/tmp/chess_app.log"
exec >"$LOG_FILE" 2>&1
echo "===== Chess.app start $(date) ====="

# --- PATH –¥–ª—è Finder ---
export PATH="/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

# --- –ü—É—Ç–∏ ---
APP_DIR="$(cd "$(dirname "$0")" && pwd)"
RES_DIR="$APP_DIR/../Resources"
PY_FILE="$RES_DIR/main.py"

echo "APP_DIR=$APP_DIR"
echo "RES_DIR=$RES_DIR"
echo "PY_FILE=$PY_FILE"

# --- Universal Python (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ arm64) ---
PYTHON="/usr/local/bin/python3"

if [ ! -x "$PYTHON" ]; then
    echo "‚ùå Python –Ω–µ –Ω–∞–π–¥–µ–Ω: $PYTHON"
    exit 1
fi

echo "Python binary:"
file "$PYTHON"

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ PyQt6 ---
/usr/bin/arch -arm64 "$PYTHON" -m pip show PyQt6 >/dev/null 2>&1 || {
    echo "‚ùå PyQt6 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è arm64 Python"
    exit 1
}

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ main.py ---
if [ ! -f "$PY_FILE" ]; then
    echo "‚ùå main.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    ls -la "$RES_DIR"
    exit 1
fi

# --- –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
echo "üöÄ –ó–∞–ø—É—Å–∫ Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (arm64)"
exec /usr/bin/arch -arm64 "$PYTHON" "$PY_FILE"
